<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue WebSocket Chat</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }
        .chat-container {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        .messages {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background: #fff;
        }
        .message {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 70%;
            margin: 5px 0;
            display: inline-block;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            text-align: right;
            margin-left: auto;
        }
        .server-message {
            background-color: #e9ecef;
            color: black;
            align-self: flex-start;
            text-align: left;
        }
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="chat-container">
        <h4 class="text-center">Vue WebSocket Chat</h4>
        <div class="alert text-center p-2" :class="isConnected ? 'alert-success' : 'alert-danger'">
            Status: {{ isConnected ? 'Connected' : 'Disconnected' }}
        </div>

        <div class="messages d-flex flex-column" ref="messageBox">
            <div v-for="msg in messages" :key="msg.id" class="message" :class="msg.type">
                <div v-html="msg.content"></div>
            </div>
        </div>

        <div class="d-flex gap-2 mt-2">
            <button class="btn btn-outline-secondary" @click="pickFile" :disabled="!isConnected">+</button>
            <input type="file" id="fileInput" ref="fileInput" accept="image/*,audio/*,video/*" @change="sendFile">
            <input type="text" v-model="message" class="form-control" placeholder="Type a message..." :disabled="!isConnected" @keyup.enter="sendMessage">
            <button class="btn btn-primary" @click="sendMessage" :disabled="!isConnected || !message.trim()">Send</button>
        </div>

        <button class="btn w-100 mt-2" :class="isConnected ? 'btn-danger' : 'btn-success'" @click="toggleConnection">
            {{ isConnected ? 'Disconnect' : 'Connect' }}
        </button>
    </div>
</div>

<script>
  const { createApp, ref, onMounted, onBeforeUnmount } = Vue;

  createApp({
    setup() {
      const ws = ref(null);
      const isConnected = ref(false);
      const messages = ref([]);
      const message = ref("");
      const fileInput = ref(null);
      const messageBox = ref(null);

      const toggleConnection = () => {
        if (isConnected.value) {
          disconnect();
        } else {
          connect();
        }
      };

      const connect = () => {
        if (ws.value) {
          ws.value.close();
        }
        ws.value = new WebSocket("ws://localhost:8000/api/chat");

        ws.value.onopen = () => {
          console.log("WebSocket connected");
          isConnected.value = true;
        };

        ws.value.onmessage = (event) => {
          console.log("WebSocket message received:", event.data);
          if (typeof event.data === "string") {
            addMessage(event.data, "server-message");
          } else {
            handleBinaryMessage(event.data);
          }
        };

        ws.value.onclose = () => {
          console.log("WebSocket disconnected");
          isConnected.value = false;
          ws.value = null;
        };

        ws.value.onerror = (error) => {
          console.error("WebSocket Error:", error);
        };
      };

      const disconnect = () => {
        if (ws.value) {
          console.log("WebSocket disconnecting");
          ws.value.close();
        }
      };

      const sendMessage = () => {
        if (!isConnected.value || !message.value.trim()) return;

        console.log("Sending message:", message.value);
        ws.value.send(message.value);
        addMessage(message.value, "user-message");
        message.value = "";
      };

      const sendFile = () => {
        if (!isConnected.value) return;

        const file = fileInput.value.files[0];
        if (!file) return;

        const allowedTypes = ["image", "audio", "video"];
        const fileType = file.type.split("/")[0];

        if (!allowedTypes.includes(fileType)) {
          alert("Only images, audio, and video files are allowed!");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (event) {
          const arrayBuffer = event.target.result;
          console.log("Sending file:", file.name);
          ws.value.send(arrayBuffer);

          let preview = "";
          if (fileType === "image") {
            preview = `<img src="${URL.createObjectURL(file)}" style="max-width: 100px; border-radius: 5px;">`;
          } else if (fileType === "audio") {
            preview = `<audio controls src="${URL.createObjectURL(file)}"></audio>`;
          } else if (fileType === "video") {
            preview = `<video controls width="150"><source src="${URL.createObjectURL(file)}"></video>`;
          }

          addMessage(`üìÅ You sent: ${file.name} <br>${preview}`, "user-message");
        };

        reader.readAsArrayBuffer(file);
        fileInput.value.value = "";
      };

      const handleBinaryMessage = (data) => {
        console.log("Handling binary message");
        const blob = new Blob([data]);
        const url = URL.createObjectURL(blob);
        addMessage(`<a href="${url}" download>üìÅ Received file</a>`, "server-message");
      };

      const addMessage = (content, type) => {
        messages.value.push({ id: Date.now(), content, type });
        setTimeout(() => {
          if (messageBox.value) {
            messageBox.value.scrollTop = messageBox.value.scrollHeight;
          }
        }, 50);
      };

      const pickFile = () => {
        fileInput.value.click();
      };

      onMounted(() => {
        connect();
      });

      onBeforeUnmount(() => {
        disconnect();
      });

      return { messages, message, isConnected, toggleConnection, sendMessage, sendFile, pickFile, fileInput, messageBox };
    }
  }).mount("#app");
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
