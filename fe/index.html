<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue WebSocket Chat</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }
        .chat-container {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        .messages {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            background: #fff;
        }
        .message {
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 70%;
            margin: 5px 0;
            display: inline-block;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            text-align: right;
            margin-left: auto;
        }
        .server-message {
            background-color: #e9ecef;
            color: black;
            align-self: flex-start;
            text-align: left;
        }
        #fileInput {
            display: none;
        }
        .nav-link {
            font-size: 0.85rem;
            text-decoration: none;
        }
        .main-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        .sidebar {
            width: 250px;
            background: #343a40;
            color: white;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chat-container {
            flex-grow: 1;
            margin-left: 15px;
        }
        .conversation-item {
            padding: 10px;
            border-bottom: 1px solid #495057;
            cursor: pointer;
        }
        .conversation-item:hover {
            background: #495057;
        }
        .user-select {
            margin-top: auto;
            margin-bottom: 15px;
        }
        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="main-container">
        <div class="sidebar">
            <h5>Conversations</h5>
            <button class="btn btn-primary w-100 mb-2" @click="createConversation" :disabled="!selectedUser">+</button>
            <div v-for="conversation in conversations" :key="conversation.id" class="conversation-item" @click="selectedUser ? selectConversation(conversation) : null" :class="{ 'disabled': !selectedUser }">
                {{ conversation.title }}
            </div>
            <div class="user-select mt-auto">
                <label for="userSelect" class="form-label">Login:</label>
                <select id="userSelect" class="form-select" v-model="selectedUser" @change="selectedUser ? (fetchConversations(), fetchUserMessages()) : null">
                    <option v-for="user in users" :key="user.id" :value="user.id">{{ user.username }}</option>
                </select>
            </div>
        </div>
        <div class="chat-container">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="mb-0">Vue WebSocket Chat</h4>
                <a href="admin.html" class="nav-link text-primary">Admin Panel</a>
            </div>
            <div class="alert text-center p-2 d-flex align-items-center justify-content-center" :class="isConnected ? 'alert-success' : 'alert-danger'">
                <span>Status: {{ isConnected ? 'Connected' : 'Disconnected' }}</span>
                <span v-if="isConnecting" class="ms-2 spinner-border spinner-border-sm"></span>
            </div>

            <div class="messages d-flex flex-column" ref="messageBox">
                <div v-for="msg in messages" :key="msg.id" class="message" :class="msg.type">
                    <div v-html="msg.content"></div>
                </div>
            </div>

            <div class="d-flex gap-2 mt-2">
                <button class="btn btn-outline-secondary" @click="pickFile" :disabled="!selectedUser || !isConnected">+</button>
                <input type="file" id="fileInput" ref="fileInput" accept="image/*,audio/*,video/*" @change="sendFile">
                <input type="text" v-model="message" class="form-control" placeholder="Type a message..." :disabled="!selectedUser || !isConnected" @keyup.enter="sendMessage">
                <button class="btn btn-primary" @click="sendMessage" :disabled="!selectedUser || !isConnected || !message.trim()">Send</button>
            </div>

            <button class="btn w-100 mt-2" :class="isConnected ? 'btn-danger' : 'btn-success'" @click="toggleConnection">
                {{ isConnected ? 'Disconnect' : 'Connect' }}
            </button>
        </div>
    </div>
</div>

<script>
  const { createApp, ref, onMounted, onBeforeUnmount } = Vue;

  createApp({
    setup() {
      const ws = ref(null);
      const isConnected = ref(false);
      const isConnecting = ref(false);
      const messages = ref([]);
      const message = ref("");
      const fileInput = ref(null);
      const messageBox = ref(null);
      const users = ref([]);
      const selectedUser = ref(null);
      const conversations = ref([]);
      const selectedConversation = ref(null);

      const connect = () => {
        if (isConnected.value || isConnecting.value) return;
        isConnecting.value = true;
        ws.value = new WebSocket("ws://localhost:8000/api/chat");

        ws.value.onopen = () => {
          isConnected.value = true;
          isConnecting.value = false;
        };

        ws.value.onmessage = (event) => {
          if (typeof event.data === "string") {
            addMessage(event.data, "server-message");
          } else {
            handleBinaryMessage(event.data);
          }
        };

        ws.value.onclose = () => {
          isConnected.value = false;
          ws.value = null;
          isConnecting.value = false;
          setTimeout(connect, 3000); // Auto-reconnect
        };

        ws.value.onerror = () => {
          isConnecting.value = false;
        };
      };

      const disconnect = () => {
        if (ws.value) ws.value.close();
      };

      const toggleConnection = () => {
        isConnected.value ? disconnect() : connect();
      };

      const sendMessage = () => {
        if (!isConnected.value || !message.value.trim()) return;
        ws.value.send(message.value);
        addMessage(message.value, "user-message");
        message.value = "";
      };

      const sendFile = () => {
        if (!isConnected.value) return;

        const file = fileInput.value.files[0];
        if (!file) return;

        const fileType = file.type.split("/")[0];
        const reader = new FileReader();

        reader.onload = function (event) {
          ws.value.send(event.target.result);

          let preview = "";
          if (fileType === "image") {
            preview = `<img src="${URL.createObjectURL(file)}" style="max-width: 100px; border-radius: 5px;">`;
          } else if (fileType === "audio") {
            preview = `<audio controls src="${URL.createObjectURL(file)}"></audio>`;
          } else if (fileType === "video") {
            preview = `<video controls width="150"><source src="${URL.createObjectURL(file)}"></video>`;
          }
          addMessage(`üìÅ You sent: ${file.name} <br>${preview}`, "user-message");
          setTimeout(() => URL.revokeObjectURL(preview), 5000);
        };

        reader.readAsArrayBuffer(file);
        fileInput.value.value = "";
      };

      const addMessage = (content, type) => {
        messages.value.push({ id: Date.now(), content, type });
        setTimeout(() => {
          if (messageBox.value) {
            messageBox.value.scrollTop = messageBox.value.scrollHeight;
          }
        }, 50);
      };

      const fetchUsers = async () => {
        try {
          const response = await fetch('http://localhost:8000/api/user?page=1&page_size=10');
          const data = await response.json();
          users.value = data.data;
        } catch (error) {
          console.error('Error fetching users:', error);
        }
      };

      const fetchConversations = async () => {
        if (!selectedUser.value) return;
        try {
          const response = await fetch(`http://localhost:8000/api/conversation?user_id=${selectedUser.value}&page=1&page_size=10`);
          const data = await response.json();
          conversations.value = data.data;
        } catch (error) {
          console.error('Error fetching conversations:', error);
        }
      };

      const selectConversation = (conversation) => {
        selectedConversation.value = conversation;
        fetchUserMessages();
      };

      const fetchUserMessages = async () => {
        if (!selectedUser.value || !selectedConversation.value) return;
        try {
          const response = await fetch(`http://localhost:8000/api/conversation/${selectedConversation.value.id}/messages`);
          const data = await response.json();
          messages.value = data.messages.map(msg => ({
            id: msg.id,
            content: msg.content,
            type: msg.sender === selectedUser.value ? 'user-message' : 'server-message'
          }));
          await fetchConversations(); // Reload conversations when user is reselected
        } catch (error) {
          console.error('Error fetching user messages:', error);
        }
      };

      const createConversation = async () => {
        if (!selectedUser.value) return;

        try {
            const response = await fetch('http://localhost:8000/api/conversation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: selectedUser.value, title: 'New Conversation' })
            });

            if (!response.ok) throw new Error('Failed to create conversation');

            await fetchConversations(); // Refresh the conversation list
        } catch (error) {
            console.error('Error creating conversation:', error);
        }
      };

      onMounted(() => {
        connect();
        fetchUsers();
      });

      onBeforeUnmount(disconnect);

      return {
        messages, message, isConnected, isConnecting, toggleConnection, sendMessage, sendFile, fileInput, messageBox, users, selectedUser, fetchUserMessages, pickFile: () => fileInput.value.click(), conversations, fetchConversations, selectConversation, createConversation
      };
    }
  }).mount("#app");
</script>
</body>
</html>
